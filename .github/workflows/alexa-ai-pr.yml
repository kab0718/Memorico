# .github/workflows/alexa-ai-pr.yml
name: Alexa AI PR (Gemini)

on:
  workflow_dispatch:
    inputs:
      task:
        description: "What to change (Japanese ok). Example: 'Upload UIにドラッグ&ドロップ時のバリデーションを追加して'"
        required: true
        type: string
      base_branch:
        description: "Base branch"
        required: false
        default: "main"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  ai_pr:
    runs-on: ubuntu-latest
    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      BASE_BRANCH: ${{ inputs.base_branch }}
      TASK: ${{ inputs.task }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BASE_BRANCH }}
          fetch-depth: 0

      - name: Setup Node (for project scripts)
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install python deps
        run: pip install --disable-pip-version-check --no-cache-dir requests

      - name: Create working branch
        run: |
          set -euo pipefail
          TS=$(date -u +"%Y%m%d-%H%M%S")
          BR="alexa/${TS}"
          echo "BRANCH=$BR" >> $GITHUB_ENV
          git checkout -b "$BR"

      - name: Setup git identity
        run: |
          git config user.name "alexa-ai-bot"
          git config user.email "alexa-ai-bot@users.noreply.github.com"

      - name: Generate patch with Gemini and
        run: python scripts/gemini_make_patch.py

      - name: Format (optional but recommended)
        run: npm run format

      - name: Lint (fail if errors)
        run: npm run lint

      - name: Commit changes (if any)
        run: |
          set -euo pipefail

          # いったん安全のためクリーニング
          rm -f .github/workflows/alexa-ai-pr.yml || true

          # add から除外（workflow と artifacts をコミットしない）
          git add -A
          git reset -- .github/workflows || true
          git reset -- artifacts || true

          if git diff --cached --quiet; then
            echo "DID_COMMIT=false" >> $GITHUB_ENV
            echo "No staged changes; exiting."
            exit 0
          fi

          git commit -m "AI: $TASK"
          echo "DID_COMMIT=true" >> $GITHUB_ENV

      - name: Push branch
        run: |
          set -euo pipefail
          if [ "${DID_COMMIT:-false}" != "true" ]; then
            echo "No commit; skipping push."
            exit 0
          fi
          git push --set-upstream origin "$BRANCH"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          if [ "${DID_COMMIT:-false}" != "true" ]; then
            echo "No commit; skipping PR."
            exit 0
          fi

          TITLE="AI: ${TASK}"
          cat > pr_body.md <<EOF
          This PR was generated automatically.

          - Task: ${TASK}
          - Base: ${BASE_BRANCH}
          - Checks: \`npm run format\`, \`npm run lint\`
          EOF

          # 失敗したらここで落ちてログが出る
          gh pr create \
            --base "${BASE_BRANCH}" \
            --head "${BRANCH}" \
            --title "${TITLE}" \
            --body-file pr_body.md

          echo "### PR" >> $GITHUB_STEP_SUMMARY
          gh pr view --json url -q .url >> $GITHUB_STEP_SUMMARY

